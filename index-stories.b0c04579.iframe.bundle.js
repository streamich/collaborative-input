"use strict";(self.webpackChunkcollaborative_input=self.webpackChunkcollaborative_input||[]).push([[141],{"./src/index.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Input:()=>Input,Textarea:()=>Textarea,__namedExportsOrder:()=>__namedExportsOrder,default:()=>__WEBPACK_DEFAULT_EXPORT__});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),json_joy_lib_json_crdt__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/json-joy/lib/json-crdt/index.js"),___WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./src/index.tsx");const __WEBPACK_DEFAULT_EXPORT__={title:"InputEditor",component:({textarea})=>{const inputRef=react__WEBPACK_IMPORTED_MODULE_0__.useRef(null),[model,clone]=react__WEBPACK_IMPORTED_MODULE_0__.useMemo((()=>{const model=json_joy_lib_json_crdt__WEBPACK_IMPORTED_MODULE_1__.Model.create();return model.api.root({text:"Hell"}),[model,model.clone()]}),[]);return react__WEBPACK_IMPORTED_MODULE_0__.useSyncExternalStore(model.api.subscribe,(()=>model.tick)),react__WEBPACK_IMPORTED_MODULE_0__.useEffect((()=>{if(!inputRef.current)return;const input=inputRef.current,unbind=(0,___WEBPACK_IMPORTED_MODULE_2__.o)((()=>model.api.str(["text"])),input,!0);return()=>{unbind()}}),[model]),react__WEBPACK_IMPORTED_MODULE_0__.createElement("div",null,textarea?react__WEBPACK_IMPORTED_MODULE_0__.createElement("textarea",{ref:inputRef}):react__WEBPACK_IMPORTED_MODULE_0__.createElement("input",{ref:inputRef,type:"text"}),react__WEBPACK_IMPORTED_MODULE_0__.createElement("div",null,react__WEBPACK_IMPORTED_MODULE_0__.createElement("button",{type:"button",onClick:()=>{const input=inputRef.current;input&&(input.value+="!")}},'Append "!" to input')),react__WEBPACK_IMPORTED_MODULE_0__.createElement("div",null,react__WEBPACK_IMPORTED_MODULE_0__.createElement("button",{type:"button",onClick:()=>{const str=model.api.str(["text"]);str.ins(str.view().length,"?")}},'Append "?" to model')),react__WEBPACK_IMPORTED_MODULE_0__.createElement("div",null,react__WEBPACK_IMPORTED_MODULE_0__.createElement("button",{type:"button",onClick:()=>{setTimeout((()=>{const str=model.api.str(["text"]);str.ins(str.view().length,"?")}),2e3)}},'Append "?" to model after 2s')),react__WEBPACK_IMPORTED_MODULE_0__.createElement("div",null,react__WEBPACK_IMPORTED_MODULE_0__.createElement("button",{type:"button",onClick:()=>{setTimeout((()=>{const str=model.api.str(["text"]);str.ins(Math.min(3,str.length()),"abc")}),2e3)}},'Insert "abc" into model at pos 3 after 2s')),react__WEBPACK_IMPORTED_MODULE_0__.createElement("div",null,react__WEBPACK_IMPORTED_MODULE_0__.createElement("button",{type:"button",onClick:()=>{setTimeout((()=>{const str=model.api.str(["text"]);str.del(3,Math.min(5,str.length()-3))}),2e3)}},"Delete 5 chars from model at pos 3 after 2s")),react__WEBPACK_IMPORTED_MODULE_0__.createElement("div",null,react__WEBPACK_IMPORTED_MODULE_0__.createElement("button",{type:"button",onClick:()=>{setTimeout((()=>{model.api.str(["text"]).del(1,1)}),2e3)}},"Delete second character after 2s")),react__WEBPACK_IMPORTED_MODULE_0__.createElement("div",null,react__WEBPACK_IMPORTED_MODULE_0__.createElement("button",{type:"button",onClick:()=>{setTimeout((()=>{model.api.str(["text"]).ins(0,"1. ")}),2e3)}},'Prepend "1. " to model after 2s')),react__WEBPACK_IMPORTED_MODULE_0__.createElement("div",null,react__WEBPACK_IMPORTED_MODULE_0__.createElement("button",{type:"button",onClick:()=>{setTimeout((()=>{model.reset(clone)}),2e3)}},"RESET after 2s")),react__WEBPACK_IMPORTED_MODULE_0__.createElement("pre",{style:{fontSize:"10px"}},react__WEBPACK_IMPORTED_MODULE_0__.createElement("code",null,model.root+"")))},argTypes:{}},Input={args:{}},Textarea={args:{textarea:!0}},__namedExportsOrder=["Input","Textarea"];Input.parameters={...Input.parameters,docs:{...Input.parameters?.docs,source:{originalSource:"{\n  args: {}\n}",...Input.parameters?.docs?.source}}},Textarea.parameters={...Textarea.parameters,docs:{...Textarea.parameters?.docs,source:{originalSource:"{\n  args: {\n    textarea: true\n  } as any\n}",...Textarea.parameters?.docs?.source}}}},"./src/index.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{o:()=>bind});var lib=__webpack_require__("./node_modules/collaborative-editor/lib/index.js");class InputEditor{constructor(str,input){this.str=str,this.input=input,input.addEventListener("input",this.onInput),document.addEventListener("selectionchange",this.onSelectionChange)}get(){return this.input.value}getLength(){return this.input.value.length}set(text){this.input.value=text}ins(position,text){const selection=this.getSelection(),value=this.get(),next=value.slice(0,position)+text+value.slice(position);if(this.set(next),selection){let[start,end]=selection;const length=text.length;start>=position&&(start+=length),end>position&&(end+=length),this.setSelection(start,end,selection[2])}}del(position,length){const selection=this.getSelection(),value=this.get(),next=value.slice(0,position)+value.slice(position+length);if(this.set(next),selection){let[start,end]=selection;start>=position&&(start=Math.max(position,start-length)),end>=position&&(end=Math.max(position,end-length)),this.setSelection(start,end,selection[2])}}getSelection(){const input=this.input,{selectionStart,selectionEnd,selectionDirection}=input;return["number"==typeof selectionStart?selectionStart:-1,"number"==typeof selectionEnd?selectionEnd:-1,"backward"===selectionDirection?-1:"forward"===selectionDirection?1:0]}setSelection(start,end,direction){const input=this.input;input.selectionStart=start>-1?start:null,input.selectionEnd=end>-1?end:null,input.selectionDirection=-1===direction?"backward":1===direction?"forward":"none"}emitChange(event){if(!event.isComposing){switch(event.inputType){case"insertText":{const data=event.data;if(!data||1!==data.length)break;const{selectionStart,selectionEnd}=this.input;if(null===selectionStart||null===selectionEnd)break;if(selectionStart!==selectionEnd)break;if(selectionStart<=0)break;const selection=this.selection;if(selectionStart-data.length!==selection.start)break;if("number"!=typeof selection.end||"number"!=typeof selection.end)break;const remove=selection.end-selection.start,change=[selection.start,remove,data];return void this.onchange([change])}case"deleteContentBackward":{const{start,end}=this.selection;if("number"!=typeof start||"number"!=typeof end)break;const change=start===end?[start-1,1,""]:[start,end-start,""];return void this.onchange([change])}case"deleteContentForward":{const{start,end}=this.selection;if("number"!=typeof start||"number"!=typeof end)break;const change=start===end?[start,1,""]:[start,end-start,""];return void this.onchange([change])}case"deleteByCut":{const{start,end}=this.selection;if("number"!=typeof start||"number"!=typeof end)break;if(start===end)break;const min=Math.min(start,end),max=Math.max(start,end),view=this.str().view(),value=this.input.value;if(view.length-value.length!==max-min)break;const change=[min,max-min,""];return void this.onchange([change])}case"insertFromPaste":{const{start,end}=this.selection;if("number"!=typeof start||"number"!=typeof end)break;const min=Math.min(start,end),max=Math.max(start,end),view=this.str().view(),input=this.input,value=input.value,newMax=Math.max(input.selectionStart??0,input.selectionEnd??0);if(newMax<=min)break;const remove=max-min,insert=value.slice(min,newMax);if(value.length!==view.length-remove+insert.length)return;const change=[min,remove,insert];return void this.onchange([change])}}this.onchange()}}onInput=event=>{this.emitChange(event)};onSelectionChange=()=>{this.onselection()};dispose(){this.input.removeEventListener("input",this.onInput),document.removeEventListener("selectionchange",this.onSelectionChange)}}const bind=(str,input,polling)=>{const editor=new InputEditor(str,input),binding=new lib.StrBinding(str,editor);return binding.syncFromModel(),binding.bind(polling),binding.unbind}}}]);