"use strict";(self.webpackChunkcollaborative_input=self.webpackChunkcollaborative_input||[]).push([[141],{"./src/index.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Input:()=>Input,Textarea:()=>Textarea,__namedExportsOrder:()=>__namedExportsOrder,default:()=>index_stories});var react=__webpack_require__("./node_modules/react/index.js"),json_crdt=__webpack_require__("./node_modules/json-joy/lib/json-crdt/index.js"),lib=__webpack_require__("./node_modules/collaborative-editor/lib/index.js");class InputEditor{constructor(str,input){this.str=str,this.input=input,input.addEventListener("input",this.onInput),document.addEventListener("selectionchange",this.onSelectionChange)}get(){return this.input.value}getLength(){return this.input.value.length}set(text){this.input.value=text}ins(position,text){const selection=this.getSelection(),value=this.get(),next=value.slice(0,position)+text+value.slice(position);if(this.set(next),selection){let[start,end]=selection;const length=text.length;start>=position&&(start+=length),end>position&&(end+=length),this.setSelection(start,end,selection[2])}}del(position,length){const selection=this.getSelection(),value=this.get(),next=value.slice(0,position)+value.slice(position+length);if(this.set(next),selection){let[start,end]=selection;start>=position&&(start=Math.max(position,start-length)),end>=position&&(end=Math.max(position,end-length)),this.setSelection(start,end,selection[2])}}getSelection(){const input=this.input,{selectionStart,selectionEnd,selectionDirection}=input;return["number"==typeof selectionStart?selectionStart:-1,"number"==typeof selectionEnd?selectionEnd:-1,"backward"===selectionDirection?-1:"forward"===selectionDirection?1:0]}setSelection(start,end,direction){const input=this.input;input.selectionStart=start>-1?start:null,input.selectionEnd=end>-1?end:null,input.selectionDirection=-1===direction?"backward":1===direction?"forward":"none"}emitChange(event){if(!event.isComposing){switch(event.inputType){case"insertText":{const data=event.data;if(!data||1!==data.length)break;const{selectionStart,selectionEnd}=this.input;if(null===selectionStart||null===selectionEnd)break;if(selectionStart!==selectionEnd)break;if(selectionStart<=0)break;const selection=this.selection;if(selectionStart-data.length!==selection.start)break;if("number"!=typeof selection.end||"number"!=typeof selection.end)break;const remove=selection.end-selection.start,change=[selection.start,remove,data];return void this.onchange([change])}case"deleteContentBackward":{const{start,end}=this.selection;if("number"!=typeof start||"number"!=typeof end)break;const change=start===end?[start-1,1,""]:[start,end-start,""];return void this.onchange([change])}case"deleteContentForward":{const{start,end}=this.selection;if("number"!=typeof start||"number"!=typeof end)break;const change=start===end?[start,1,""]:[start,end-start,""];return void this.onchange([change])}case"deleteByCut":{const{start,end}=this.selection;if("number"!=typeof start||"number"!=typeof end)break;if(start===end)break;const min=Math.min(start,end),max=Math.max(start,end),view=this.str().view(),value=this.input.value;if(view.length-value.length!=max-min)break;const change=[min,max-min,""];return void this.onchange([change])}case"insertFromPaste":{const{start,end}=this.selection;if("number"!=typeof start||"number"!=typeof end)break;const min=Math.min(start,end),max=Math.max(start,end),view=this.str().view(),input=this.input,value=input.value,newMax=Math.max(input.selectionStart??0,input.selectionEnd??0);if(newMax<=min)break;const remove=max-min,insert=value.slice(min,newMax);if(value.length!==view.length-remove+insert.length)return;const change=[min,remove,insert];return void this.onchange([change])}}this.onchange()}}onInput=event=>{this.emitChange(event)};onSelectionChange=()=>{this.onselection()};dispose(){this.input.removeEventListener("input",this.onInput),document.removeEventListener("selectionchange",this.onSelectionChange)}}var jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js");const Demo=_ref=>{let{textarea}=_ref;const inputRef=react.useRef(null),[model,clone]=react.useMemo((()=>{const model=json_crdt.Model.withLogicalClock();return model.api.root({text:"Hell"}),[model,model.clone()]}),[1]);return react.useSyncExternalStore(model.api.subscribe,(()=>model.tick)),react.useEffect((()=>{if(!inputRef.current)return;const unbind=((str,input,polling)=>{const editor=new InputEditor(str,input),binding=new lib.StrBinding(str,editor);return binding.syncFromModel(),binding.bind(polling),binding.unbind})((()=>model.api.str(["text"])),inputRef.current,!0);return()=>{unbind()}}),[model]),(0,jsx_runtime.jsxs)("div",{children:[textarea?(0,jsx_runtime.jsx)("textarea",{ref:inputRef}):(0,jsx_runtime.jsx)("input",{ref:inputRef,type:"text"}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{const input=inputRef.current;input&&(input.value+="!")},children:'Append "!" to input'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{const str=model.api.str(["text"]);str.ins(str.view().length,"?")},children:'Append "?" to model'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{setTimeout((()=>{const str=model.api.str(["text"]);str.ins(str.view().length,"?")}),2e3)},children:'Append "?" to model after 2s'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{setTimeout((()=>{const str=model.api.str(["text"]);str.ins(Math.min(3,str.length()),"abc")}),2e3)},children:'Insert "abc" into model at pos 3 after 2s'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{setTimeout((()=>{const str=model.api.str(["text"]);str.del(3,Math.min(5,str.length()-3))}),2e3)},children:"Delete 5 chars from model at pos 3 after 2s"})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{setTimeout((()=>{model.api.str(["text"]).del(1,1)}),2e3)},children:"Delete second character after 2s"})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{setTimeout((()=>{model.api.str(["text"]).ins(0,"1. ")}),2e3)},children:'Prepend "1. " to model after 2s'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{setTimeout((()=>{model.reset(clone)}),2e3)},children:"RESET after 2s"})}),(0,jsx_runtime.jsx)("pre",{style:{fontSize:"10px"},children:(0,jsx_runtime.jsx)("code",{children:model.root+""})})]})};Demo.displayName="Demo";const index_stories={title:"StrBinding",component:Demo,argTypes:{}},Input={args:{}},Textarea={args:{textarea:!0}};Input.parameters={...Input.parameters,docs:{...Input.parameters?.docs,source:{originalSource:"{\n  args: {}\n}",...Input.parameters?.docs?.source}}},Textarea.parameters={...Textarea.parameters,docs:{...Textarea.parameters?.docs,source:{originalSource:"{\n  args: {\n    textarea: true\n  } as any\n}",...Textarea.parameters?.docs?.source}}};const __namedExportsOrder=["Input","Textarea"]}}]);