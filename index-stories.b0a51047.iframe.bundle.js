"use strict";(self.webpackChunkcollaborative_input=self.webpackChunkcollaborative_input||[]).push([[987],{"./src/index.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Input:()=>Input,Textarea:()=>Textarea,__namedExportsOrder:()=>__namedExportsOrder,default:()=>index_stories});var react=__webpack_require__("./node_modules/react/index.js"),json_crdt=__webpack_require__("./node_modules/json-joy/es2020/json-crdt/index.js"),lib=__webpack_require__("./node_modules/collaborative-editor/lib/index.js");class InputEditor{constructor(str,input){this.str=str,this.input=input,input.addEventListener("input",this.onInput),document.addEventListener("selectionchange",this.onSelectionChange)}get(){return this.input.value}getLength(){return this.input.value.length}set(text){this.input.value=text}getSelection(){const input=this.input,{selectionStart,selectionEnd,selectionDirection}=input;return["number"==typeof selectionStart?selectionStart:-1,"number"==typeof selectionEnd?selectionEnd:-1,"backward"===selectionDirection?-1:"forward"===selectionDirection?1:0]}setSelection(start,end,direction){const input=this.input;input.selectionStart=start>-1?start:null,input.selectionEnd=end>-1?end:null,input.selectionDirection=-1===direction?"backward":1===direction?"forward":"none"}createChange(event){const{input}=this,{data,inputType,isComposing}=event;if(!isComposing)switch(inputType){case"deleteContentBackward":{const{selection}=this,{start,end}=selection;if("number"!=typeof start||"number"!=typeof end)return;return start===end?[start-1,1,""]:[start,end-start,""]}case"deleteContentForward":{const{selection}=this,{start,end}=selection;if("number"!=typeof start||"number"!=typeof end)return;return start===end?[start,1,""]:[start,end-start,""]}case"deleteByCut":{const{start,end}=this.selection;if("number"!=typeof start||"number"!=typeof end)return;if(start===end)return;const min=Math.min(start,end),max=Math.max(start,end),view=this.str.view(),value=this.input.value;if(view.length-value.length!=max-min)return;return[min,max-min,""]}case"insertFromPaste":{const{start,end}=this.selection;if("number"!=typeof start||"number"!=typeof end)return;const min=Math.min(start,end),max=Math.max(start,end),view=this.str.view(),input=this.input,value=input.value,newMax=Math.max(input.selectionStart??0,input.selectionEnd??0);if(newMax<=min)return;const remove=max-min,insert=value.slice(min,newMax);if(value.length!==view.length-remove+insert.length)return;return[min,remove,insert]}case"insertText":{if(!data||1!==data.length)return;const{selectionStart,selectionEnd}=input;if(null===selectionStart||null===selectionEnd)return;if(selectionStart!==selectionEnd)return;if(selectionStart<=0)return;const selection=this.selection;if(selectionStart-data.length!==selection.start)return;if("number"!=typeof selection.end||"number"!=typeof selection.end)return;const remove=selection.end-selection.start;return[selection.start,remove,data]}}}onInput=event=>{const change=this.createChange(event);this.onchange(change)};onSelectionChange=()=>{this.onselection()};dispose(){this.input.removeEventListener("input",this.onInput),document.removeEventListener("selectionchange",this.onSelectionChange)}}var jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js");const Demo=_ref=>{let{textarea}=_ref;const inputRef=react.useRef(null),[model,clone]=react.useMemo((()=>{const model=json_crdt.Model.withLogicalClock();return model.api.root({text:"Hell"}),[model,model.clone()]}),[1]);return react.useSyncExternalStore(model.api.subscribe,(()=>model.tick)),react.useEffect((()=>{if(!inputRef.current)return;const input=inputRef.current,unbind=((str,input,polling)=>{const editor=new InputEditor(str,input),binding=new lib.StrBinding(str,editor);return binding.syncFromModel(),binding.bind(polling),binding.unbind})(model.api.str(["text"]),input,!0);return()=>{unbind()}}),[model]),(0,jsx_runtime.jsxs)("div",{children:[textarea?(0,jsx_runtime.jsx)("textarea",{ref:inputRef}):(0,jsx_runtime.jsx)("input",{ref:inputRef,type:"text"}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{const input=inputRef.current;input&&(input.value+="!")},children:'Append "!" to input'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{const str=model.api.str(["text"]);str.ins(str.view().length,"?")},children:'Append "?" to model'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{setTimeout((()=>{const str=model.api.str(["text"]);str.ins(str.view().length,"?")}),2e3)},children:'Append "?" to model after 2s'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{setTimeout((()=>{model.api.str(["text"]).ins(0,"1. ")}),2e3)},children:'Prepend "1. " to model after 2s'})}),(0,jsx_runtime.jsx)("div",{children:(0,jsx_runtime.jsx)("button",{onClick:()=>{setTimeout((()=>{model.reset(clone)}),2e3)},children:"RESET after 2s"})}),(0,jsx_runtime.jsx)("pre",{style:{fontSize:"10px"},children:(0,jsx_runtime.jsx)("code",{children:model.root+""})})]})};Demo.displayName="Demo";const index_stories={title:"StrBinding",component:Demo,argTypes:{}},Input={args:{}},Textarea={args:{textarea:!0}};Input.parameters={...Input.parameters,docs:{...Input.parameters?.docs,source:{originalSource:"{\n  args: {}\n}",...Input.parameters?.docs?.source}}},Textarea.parameters={...Textarea.parameters,docs:{...Textarea.parameters?.docs,source:{originalSource:"{\n  args: ({\n    textarea: true\n  } as any)\n}",...Textarea.parameters?.docs?.source}}};const __namedExportsOrder=["Input","Textarea"]}}]);